<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPTMart — Curated Custom GPTs</title>
  <meta name="description" content="A lightning-fast, keyboard-driven directory of the best Custom GPTs." />
  <meta name="theme-color" content="#0b0f19" />
  <meta name="color-scheme" content="dark" />
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-6PTBJ3N2DK"></script>
  <script>
    window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}
    gtag('js',new Date()); gtag('config','G-6PTBJ3N2DK');
    const track=(e,p={})=>{ try{gtag('event',e,p)}catch{} };
  </script>
  <style>
    :root{--bg:#050815;--bg2:#080e1f;--panel:#0b1a36;--card:#0e162f;--stroke:#16213a;--text:#e6ecff;--muted:#9eb0d6;--accent:#2c57c7}
    *{box-sizing:border-box} html,body{height:100%;margin:0}
    body{font-family:Inter,system-ui;background:linear-gradient(180deg,var(--bg),#091229 60%,#0a1333 100%);color:var(--text)}
    .container{width:94%;max-width:1200px;margin:0 auto}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(5,8,21,.65);backdrop-filter:blur(10px);border-bottom:1px solid var(--stroke)}
    .top-row{display:flex;align-items:center;gap:16px;justify-content:space-between;padding:12px 0}
    .brand{font-weight:800;text-decoration:none;color:inherit}
    .btn{background:#1b2a55;border:1px solid #1a2b5a;padding:10px 14px;border-radius:12px;color:#e7efff;text-decoration:none;font-weight:700;display:inline-flex;align-items:center;cursor:pointer}
    .btn.accent{background:var(--accent);border-color:#2e53b7}
    .input{border:1px solid var(--stroke);background:#0b152c;border-radius:12px;padding:12px 14px;color:var(--text);width:100%}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-top:18px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:18px;padding:14px;display:flex;gap:14px;align-items:flex-start;transition:.2s transform,.2s box-shadow}
    .card:hover{transform:translateY(-2px);box-shadow:0 0 0 2px rgba(110,168,255,.15),0 30px 120px -40px rgba(60,120,255,.35)}
    .icon{width:48px;height:48px;border-radius:10px;overflow:hidden;border:1px solid #1f2937;background:#0a1324;flex-shrink:0}
    .icon img{width:100%;height:100%;object-fit:cover}
    .title{font-weight:800;margin:0}
    .desc{color:#a7b0c0;font-size:14px;line-height:1.5}
    /* Welcome Overlay */
    #welcome{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.78);backdrop-filter:blur(10px);z-index:999}
    .wel{width:min(92vw,740px);border-radius:20px;border:1px solid var(--stroke);background:linear-gradient(180deg,#0c1327,#0b1a36);box-shadow:0 10px 40px rgba(0,0,0,.35);padding:28px;text-align:center}
    .wel h1{margin:0 0 8px;font-size:34px}
    .wel p{margin:0 0 18px;color:var(--muted)}
    .wel .input{margin-top:10px}
    .wel .row{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    textarea.input{min-height:84px;resize:vertical}
  </style>
</head>
<body>
  <!-- Welcome overlay (once per session) -->
  <div id="welcome">
    <form id="welForm" class="wel" novalidate>
      <h1>Welcome to GPTMart 🎉</h1>
      <p>Discover curated Custom GPTs. Leave your email and a short note so we can send you the best stuff.</p>
      <input id="welEmail" class="input" type="email" placeholder="Your email" required />
      <textarea id="welMsg" class="input" placeholder="Your short message (what do you need?)" required></textarea>
      <div class="row">
        <button type="button" class="btn" id="welSkip">Skip</button>
        <button type="submit" class="btn accent" id="welSubmit">Subscribe</button>
      </div>
      <div class="muted" id="welNote" style="margin-top:8px"></div>
    </form>
  </div>

  <header class="topbar">
    <div class="container top-row">
      <a class="brand" href="/">GPTMart</a>
      <div>
        <a class="btn accent" href="#content">Browse</a>
        <a class="btn" href="/login.html">Admin</a>
      </div>
    </div>
  </header>

  <main id="content" class="container" style="padding:24px 0;">
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <input id="q" class="input" type="search" placeholder="Search title, tags, categories…"/>
      <select id="cat" class="input" style="max-width:260px"></select>
      <select id="sort" class="input" style="max-width:220px">
        <option value="featured">Featured first</option>
        <option value="title">Title A→Z</option>
        <option value="recent">Recently added</option>
      </select>
      <button class="btn" id="reset">Reset</button>
    </div>

    <div id="grid" class="grid"></div>
  </main>

  <script>
    const API_BASE = 'https://connector-320f.onrender.com';
    const OVERLAY_KEY = 'gptmart_welcome_shown_v3'; // once/session

    const $ = (s, el=document)=>el.querySelector(s);
    const contains=(t,q)=>(t||'').toLowerCase().includes((q||'').toLowerCase());
    let ALL_ITEMS=[]; const state={ q:'', cat:'All', sort:'featured' };

    // ---- welcome overlay ----
    function emailOK(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
    function showWelcome(){ $('#welcome').style.display='grid'; }
    function hideWelcome(){ $('#welcome').style.display='none'; }

    function initWelcome(){
      if(!sessionStorage.getItem(OVERLAY_KEY)){ showWelcome(); sessionStorage.setItem(OVERLAY_KEY,'1'); }
      $('#welSkip').addEventListener('click', hideWelcome);
      $('#welForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email=$('#welEmail').value.trim(), message=$('#welMsg').value.trim(), note=$('#welNote');
        note.textContent='';
        if(!emailOK(email)){ note.textContent='Please enter a valid email.'; return; }
        if(!message){ note.textContent='Please add a short message.'; return; }
        $('#welSubmit').disabled=true;
        try{
          const r=await fetch(`${API_BASE}/api/leads`,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ email, message, ua:navigator.userAgent, tz:Intl.DateTimeFormat().resolvedOptions().timeZone })
          });
          if(!r.ok) throw new Error(await r.text());
          track('lead_submitted', { where:'welcome_overlay' });
          note.textContent='✅ Thanks! Enjoy exploring.'; setTimeout(hideWelcome, 600);
        }catch{ note.textContent='❌ Could not submit. Try again.'; }
        finally{ $('#welSubmit').disabled=false; }
      });
    }

    // ---- GPT grid ----
    async function fetchPublic(){
      const res=await fetch(`${API_BASE}/api/gpts/public`,{cache:'no-store'});
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    function renderCategories(){
      const cats=[...new Set(ALL_ITEMS.flatMap(x=>x.categories||[]))].sort();
      $('#cat').innerHTML='<option value="All">All Categories</option>'+cats.map(c=>`<option>${c}</option>`).join('');
    }
    function renderGrid(){
      const filtered=ALL_ITEMS.filter(x=>{
        const inQ=!state.q || [x.title,x.desc,(x.categories||[]).join(','),(x.tags||[]).join(',')].some(v=>contains(v,state.q));
        const inCat=state.cat==='All' || (x.categories||[]).includes(state.cat);
        return inQ && inCat;
      });
      const sorted=filtered.slice().sort((a,b)=>{
        if(state.sort==='title') return (a.title||'').localeCompare(b.title||'');
        if(state.sort==='recent') return (b.createdAt||0)-(a.createdAt||0);
        const feat=(b.featured?1:0)-(a.featured?1:0);
        if(feat) return feat;
        return (b.createdAt||0)-(a.createdAt||0);
      });
      $('#grid').innerHTML=sorted.map(cardTpl).join('') || '<p>No results.</p>';
    }
    function cardTpl(x){
      return `<article class="card">
        ${x.featured?`<span style="position:absolute;right:10px;top:10px;background:#1a2c5c;border:1px solid #254a9b;border-radius:999px;padding:4px 8px;font-size:11px">Featured</span>`:''}
        <div class="icon">${x.icon?`<img src="${x.icon}" alt="">`:''}</div>
        <div style="display:flex;flex-direction:column;gap:10px;position:relative">
          <h3 class="title">${x.title||''}</h3>
          <p class="desc">${x.desc||''}</p>
          <div><a class="btn accent" href="${x.url}" target="_blank" rel="noopener">Open</a></div>
        </div>
      </article>`;
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      initWelcome();
      try{
        const data=await fetchPublic();
        ALL_ITEMS=data.items||[];
        renderCategories(); renderGrid();
      }catch(e){
        console.error(e); $('#grid').innerHTML='<p>Failed to load. Try again later.</p>';
      }
      $('#q').addEventListener('input',e=>{state.q=e.target.value;renderGrid()});
      $('#cat').addEventListener('change',e=>{state.cat=e.target.value;renderGrid()});
      $('#sort').addEventListener('change',e=>{state.sort=e.target.value;renderGrid()});
      $('#reset').addEventListener('click',()=>{state.q='';$('#q').value='';state.cat='All';$('#cat').value='All';state.sort='featured';$('#sort').value='featured';renderGrid()});
    });
  </script>
</body>
</html>
