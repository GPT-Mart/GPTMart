<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — GPTMart</title>
  <meta name="robots" content="noindex, nofollow" />
  <meta name="gptmart-api" content="https://connector-320f.onrender.com" />
  <style>
    :root{
      --bg:#050815; --panel:#0b1a36; --text:#e6ecff;
      --accent:#6ea8ff; --accent-2:#3b82f6;
      --stroke:#16213a; --radius:14px;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui;background:var(--bg);color:var(--text);margin:0;}
    .container{width:94%;max-width:1200px;margin:0 auto}
    .topbar{background:rgba(5,8,21,.65);backdrop-filter:blur(10px);border-bottom:1px solid var(--stroke);padding:12px 0;}
    .top-row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .brand{font-weight:800;}
    .btn{background:#1b2a55;border:1px solid #1a2b5a;padding:10px 16px;border-radius:10px;color:#e7efff;font-weight:700;cursor:pointer;font-size:13px;}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.accent{background:#2c57c7;border-color:#2e53b7;}
    .btn.ghost{background:#0b152c;border-color:#16213a;}
    .btn.danger{background:#450a0a;border-color:#991b1b;color:#fca5a5;}
    .section{padding:30px 0}
    .input{border:1px solid var(--stroke);background:#091327;border-radius:12px;padding:12px 14px;color:var(--text);width:100%;}
    .panel{background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);padding:16px}
    .row{display:flex;gap:10px;align-items:center;margin-bottom:10px;}
    table{width:100%;border-collapse:separate;border-spacing:0 8px;}
    th,td{text-align:left;font-size:14px;padding:12px;border-top:1px solid var(--stroke);border-bottom:1px solid var(--stroke);vertical-align:top}
    tbody tr{background:#0b1426;}
    tbody tr td:first-child{border-left:1px solid var(--stroke);border-top-left-radius:10px;border-bottom-left-radius:10px;}
    tbody tr td:last-child{border-right:1px solid var(--stroke);border-top-right-radius:10px;border-bottom-right-radius:10px;}
    .hide{display:none!important}
    dialog{border:1px solid var(--stroke);background:var(--panel);color:var(--text);border-radius:var(--radius);padding:0;max-width:960px;width:95vw;}
    dialog::backdrop{background:rgba(0,0,0,.6);backdrop-filter:blur(4px);}
    .muted{color:#9eb0d6;font-size:12px;}
    .input.big{height:48px;display:flex;align-items:center;}
    .chip-toolbar{display:flex;flex-wrap:wrap;gap:10px;padding:10px;}
    .chip{user-select:none;cursor:pointer;border:1px solid var(--stroke);background:#0e1936;color:#d7e3ff;border-radius:999px;padding:8px 12px;font-size:13px;}
    .chip.active{background:#1b2a55;border-color:#2e53b7;box-shadow:0 0 0 2px rgba(59,130,246,.25) inset;}

    /* Pending badge */
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid #7c2d12;background:#2b1512;color:#ffedd5}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container top-row">
      <div class="brand">Admin Panel</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn ghost" id="pendingToggle">Pending (0)</button>
        <button class="btn" id="refreshBtn">⟳ Refresh</button>
        <button class="btn accent" id="addBtn">＋ New Item</button>
        <button class="btn" id="logoutBtn" style="display:none;">Logout</button>
      </div>
    </div>
  </header>

  <main class="container section">
    <div id="loginView">
      <div class="panel" style="max-width:420px;margin:40px auto;">
        <h3>Owner Sign-in</h3>
        <p class="muted">Enter your PIN to manage items.</p>
        <form id="loginForm" class="row">
          <input id="pin" type="password" placeholder="Enter owner PIN" class="input" required autocomplete="current-password"/>
          <button class="btn accent" type="submit" id="loginBtn">Enter</button>
        </form>
        <p id="loginMsg" class="muted" style="min-height:18px;"></p>
      </div>
    </div>

    <div id="adminView" class="hide">
      <div class="panel">
        <h3 style="margin-top:0;">GPT Items</h3>
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th style="min-width:220px">Title</th>
                <th style="min-width:220px">Cat/Tags</th>
                <th>Featured</th>
                <th>Status</th>
                <th style="min-width:360px">Actions</th>
              </tr>
            </thead>
            <tbody id="itemsTable"></tbody>
          </table>
        </div>
      </div>

      <div class="panel" style="margin-top: 24px;">
        <h3 style="margin-top:0;">Collected Leads</h3>
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th style="min-width:180px">Date</th>
                <th style="min-width:220px">Email</th>
                <th>Message</th>
              </tr>
            </thead>
            <tbody id="leadsTable"></tbody>
          </table>
          <p id="noLeadsMsg" class="muted" style="display:none; padding: 10px;">No leads collected yet.</p>
        </div>
      </div>

    </div>
  </main>

  <dialog id="itemModal">
    </dialog>

  <script>
    // ===== base & utils
    const API_BASE=(document.querySelector('meta[name="gptmart-api"]')?.content||'').replace(/\/+$/,'');
    const $=s=>document.querySelector(s);
    const loginView=$('#loginView'),adminView=$('#adminView');
    const loginBtn=$('#loginBtn'),loginMsg=$('#loginMsg');
    const pendingToggle=$('#pendingToggle');
    let allItemsCache=[], showOnlyPending=false;

    async function api(endpoint,method='GET',body=null){
      // ... (function is unchanged) ...
    }

    async function checkAuthAndLoad(){
      // ... (function is unchanged) ...
    }

    // login/logout
    // ... (functions are unchanged) ...

    // top buttons
    $('#refreshBtn').addEventListener('click',()=>loadAdminData());
    pendingToggle.addEventListener('click',()=>{showOnlyPending=!showOnlyPending;renderTable();});

    // ===== data load & table
    async function loadAdminData(){
      try{
        const data=await api('/api/gpts/all','GET');
        
        // GPT Items
        allItemsCache = data.items || [];
        updatePendingCount();
        renderTable();

        // --- NEW: Load Leads ---
        const allLeads = data.leads || [];
        renderLeadsTable(allLeads);

      }catch(e){alert('Failed to load data.');}
    }

    function updatePendingCount(){
      const n=allItemsCache.filter(i=>i.status==='pending').length;
      pendingToggle.textContent=`Pending (${n})`;
      pendingToggle.className = 'btn ' + (showOnlyPending ? 'accent' : 'ghost');
    }

    function renderTable(){
      updatePendingCount();
      const list = showOnlyPending ? allItemsCache.filter(i=>i.status==='pending') : allItemsCache;
      const tbody=$('#itemsTable');
      tbody.innerHTML=list.map(i=>`
        <tr>
          <td>
            <div style="display:flex;gap:10px;align-items:flex-start;">
              ${i.icon?`<img src="${i.icon}" style="width:28px;height:28px;border-radius:6px;border:1px solid var(--stroke);object-fit:cover;">`:''}
              <div>
                <div style="font-weight:700;display:flex;gap:10px;align-items:center">
                  <span>${escapeHtml(i.title||'')}</span>
                  ${i.status==='pending'?`<span class="badge">Pending</span>`:''}
                </div>
                <a href="${i.url||'#'}" target="_blank" class="muted" style="text-decoration:underline;word-break:break-all;">Open link</a>
              </div>
            </div>
          </td>
          <td><small>${(i.categories||[]).join(', ')}</small><br><small style="color:#81a3ff">${(i.tags||[]).join(', ')}</small></td>
          <td>${i.featured ? '⭐️' : '—'}</td>
          <td>${i.status}</td>
          <td style="display:flex; gap: 6px; flex-wrap: wrap;">
            ${i.status==='pending'
              ? `<button class="btn accent" onclick="approveSubmission('${i.id}')">Approve</button>`
              : ''}
            <button class="btn" onclick="openModal('${i.id}')">Edit</button>
            <button class="btn" onclick="toggleFeature('${i.id}')">${i.featured ? 'Unfeature' : 'Feature'}</button>
            <button class="btn" onclick="toggleStatus('${i.id}')">${i.status === 'live' ? 'Hide' : 'Unhide'}</button>
            <a class="btn" href="${i.url||'#'}" target="_blank" rel="noopener">Open</a>
            <button class="btn danger" onclick="deleteItem('${i.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    // --- NEW: Render Leads Table ---
    function renderLeadsTable(leads = []) {
      const tbody = $('#leadsTable');
      const noMsg = $('#noLeadsMsg');
      if (!leads.length) {
        tbody.innerHTML = '';
        noMsg.style.display = 'block';
        return;
      }
      noMsg.style.display = 'none';
      tbody.innerHTML = leads.map(lead => `
        <tr>
          <td><small>${new Date(lead.createdAt || 0).toLocaleString()}</small></td>
          <td>${escapeHtml(lead.email || '')}</td>
          <td><small>${escapeHtml(lead.message || '—')}</small></td>
        </tr>
      `).join('');
    }


    function escapeHtml(s=''){return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));}

    // ===== modal / create-edit
    // ... (this section is unchanged) ...

    // ===== actions
    // ... (this section is unchanged) ...
    
    // image helper (crop+resize square)
    // ... (this function is unchanged) ...

    // go
    checkAuthAndLoad();
  </script>
</body>
</html>
