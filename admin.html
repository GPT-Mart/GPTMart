<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî GPTMart</title>
  <meta name="robots" content="noindex, nofollow" />
  <meta name="gptmart-api" content="https://connector-320f.onrender.com" />

  <style>
    :root{
      --bg:#050815;--panel:#0b1a36;--text:#e6ecff;
      --accent:#6ea8ff;--accent-2:#3b82f6;
      --stroke:#16213a;--radius:14px;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui;background:var(--bg);color:var(--text);margin:0;}
    .container{width:94%;max-width:1200px;margin:0 auto}
    .topbar{background:rgba(5,8,21,.65);backdrop-filter:blur(10px);border-bottom:1px solid var(--stroke);padding:12px 0;}
    .top-row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .brand{font-weight:800;}
    .btn{background:#1b2a55;border:1px solid #1a2b5a;padding:10px 16px;border-radius:10px;color:#e7efff;font-weight:700;cursor:pointer;font-size:13px;}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.accent{background:#2c57c7;border-color:#2e53b7;}
    .btn.ghost{background:#0b152c;border-color:#16213a;}
    .btn.danger{background:#450a0a;border-color:#991b1b;color:#fca5a5;}
    .section{padding:30px 0}
    .input{border:1px solid var(--stroke);background:#091327;border-radius:12px;padding:12px 14px;color:var(--text);width:100%;}
    .panel{background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);padding:16px}
    .row{display:flex;gap:10px;align-items:center;margin-bottom:10px;}
    table{width:100%;border-collapse:separate;border-spacing:0 8px;}
    th,td{text-align:left;font-size:14px;padding:12px;border-top:1px solid var(--stroke);border-bottom:1px solid var(--stroke);vertical-align:top}
    tbody tr{background:#0b1426;}
    tbody tr td:first-child{border-left:1px solid var(--stroke);border-top-left-radius:10px;border-bottom-left-radius:10px;}
    tbody tr td:last-child{border-right:1px solid var(--stroke);border-top-right-radius:10px;border-bottom-right-radius:10px;}
    .hide{display:none!important}
    dialog{border:1px solid var(--stroke);background:var(--panel);color:var(--text);border-radius:var(--radius);padding:0;max-width:960px;width:95vw;}
    dialog::backdrop{background:rgba(0,0,0,.6);backdrop-filter:blur(4px);}
    .muted{color:#9eb0d6;font-size:12px;}
    .input.big{height:48px;display:flex;align-items:center;}
    .chip-toolbar{display:flex;flex-wrap:wrap;gap:10px;padding:10px;}
    .chip{user-select:none;cursor:pointer;border:1px solid var(--stroke);background:#0e1936;color:#d7e3ff;border-radius:999px;padding:8px 12px;font-size:13px;}
    .chip.active{background:#1b2a55;border-color:#2e53b7;box-shadow:0 0 0 2px rgba(59,130,246,.25) inset;}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid #7c2d12;background:#2b1512;color:#ffedd5}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="container top-row">
      <div class="brand">Admin Panel</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn ghost" id="pendingToggle">Pending (0)</button>
        <button class="btn accent" id="seedBtn">üå± Seed GPTs</button>
        <button class="btn" id="refreshBtn">‚ü≥ Refresh</button>
        <button class="btn" id="logoutBtn" style="display:none;">Logout</button>
      </div>
    </div>
  </header>

  <main class="container section">
    <div id="loginView">
      <div class="panel" style="max-width:420px;margin:40px auto;">
        <h3>Owner Sign-in</h3>
        <p class="muted">Enter your PIN to manage GPTs.</p>
        <form id="loginForm" class="row">
          <input id="pin" type="password" placeholder="Enter owner PIN" class="input" required autocomplete="current-password"/>
          <button class="btn accent" type="submit" id="loginBtn">Enter</button>
        </form>
        <p id="loginMsg" class="muted" style="min-height:18px;"></p>
      </div>
    </div>

    <div id="adminView" class="hide">
      <div class="panel">
        <h3>GPT Items</h3>
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr><th>Title</th><th>Cat/Tags</th><th>Featured</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody id="itemsTable"></tbody>
          </table>
        </div>
      </div>

      <div class="panel" style="margin-top:24px;">
        <h3>Collected Leads</h3>
        <div style="overflow-x:auto">
          <table>
            <thead><tr><th>Date</th><th>Email</th><th>Message</th></tr></thead>
            <tbody id="leadsTable"></tbody>
          </table>
          <p id="noLeadsMsg" class="muted" style="display:none;padding:10px;">No leads collected yet.</p>
        </div>
      </div>
    </div>
  </main>

<script>
const API_BASE=(document.querySelector('meta[name="gptmart-api"]')?.content||'').replace(/\/+$/,'');
const $=s=>document.querySelector(s);
const loginView=$('#loginView'),adminView=$('#adminView');
const loginBtn=$('#loginBtn'),loginMsg=$('#loginMsg');
const pendingToggle=$('#pendingToggle');
let allItemsCache=[], showOnlyPending=false, allLeadsCache=[];

async function api(endpoint,method='GET',body=null){
  const url=`${API_BASE}${endpoint}`;
  const opts={method,credentials:'include',headers:{}};
  if(body){opts.headers['Content-Type']='application/json';opts.body=JSON.stringify(body);}
  const res=await fetch(url,opts);
  if(!res.ok)throw new Error(await res.text());
  if(res.status===204)return null;
  return res.json();
}

async function checkAuthAndLoad(){
  try{
    await api('/api/gpts/all');
    loginView.classList.add('hide');adminView.classList.remove('hide');
    $('#logoutBtn').style.display='block';
    await loadAdminData();
  }catch{
    loginView.classList.remove('hide');adminView.classList.add('hide');
    $('#logoutBtn').style.display='none';
  }
}

// login/logout
$('#loginForm').addEventListener('submit',async e=>{
  e.preventDefault();const pin=$('#pin').value.trim();if(!pin)return;
  loginBtn.disabled=true;loginMsg.textContent='Signing in‚Ä¶';
  try{
    const res=await api('/api/login','POST',{pin});
    if(res.success){loginMsg.textContent='‚úÖ Logged in';await checkAuthAndLoad();}
    else{loginMsg.textContent='‚ùå '+(res.error||'Login failed');}
  }catch{loginMsg.textContent='‚ùå Server error';}
  finally{loginBtn.disabled=false;}
});
$('#logoutBtn').addEventListener('click',()=>{adminView.classList.add('hide');loginView.classList.remove('hide');$('#logoutBtn').style.display='none';});

// buttons
$('#refreshBtn').addEventListener('click',()=>loadAdminData());
$('#seedBtn').addEventListener('click',async()=>{
  if(!confirm('Seed all GPTs?'))return;
  try{await api('/api/gpts/seed-defaults','POST');alert('‚úÖ GPTs seeded successfully!');await loadAdminData();}
  catch{alert('Failed to seed GPTs.');}
});
pendingToggle.addEventListener('click',()=>{showOnlyPending=!showOnlyPending;renderTable();});

async function loadAdminData(){
  try{
    const data=await api('/api/gpts/all');
    allItemsCache=data.items||[];
    updatePendingCount();renderTable();
    const leads=await api('/api/leads/all').catch(()=>({items:[]}));
    allLeadsCache=leads.items||[];
    renderLeadsTable(allLeadsCache);
  }catch{alert('Failed to load data');}
}

function updatePendingCount(){
  const n=allItemsCache.filter(i=>i.status==='pending').length;
  pendingToggle.textContent=`Pending (${n})`;
  pendingToggle.className='btn '+(showOnlyPending?'accent':'ghost');
}

function renderTable(){
  updatePendingCount();
  const list=showOnlyPending?allItemsCache.filter(i=>i.status==='pending'):allItemsCache;
  $('#itemsTable').innerHTML=list.map(i=>`
    <tr>
      <td><b>${escapeHtml(i.title||'')}</b><br>
        <a href="${i.url||'#'}" target="_blank" class="muted">${i.url}</a>
      </td>
      <td><small>${(i.categories||[]).join(', ')}</small><br><small style="color:#81a3ff">${(i.tags||[]).join(', ')}</small></td>
      <td>${i.featured?'‚≠êÔ∏è':'‚Äî'}</td>
      <td>${i.status}</td>
      <td>
        ${i.status==='pending'?`<button class="btn accent" onclick="approve('${i.id}')">Approve</button>`:''}
        <button class="btn" onclick="toggleFeature('${i.id}')">${i.featured?'Unfeature':'Feature'}</button>
        <button class="btn" onclick="toggleStatus('${i.id}')">${i.status==='live'?'Hide':'Unhide'}</button>
        <a class="btn" href="${i.url}" target="_blank">Open</a>
        <button class="btn danger" onclick="deleteItem('${i.id}')">Delete</button>
      </td>
    </tr>`).join('');
}

function renderLeadsTable(leads=[]){
  const tbody=$('#leadsTable'),noMsg=$('#noLeadsMsg');
  if(!leads.length){tbody.innerHTML='';noMsg.style.display='block';return;}
  noMsg.style.display='none';
  tbody.innerHTML=leads.map(l=>`
    <tr>
      <td><small>${new Date(l.createdAt||0).toLocaleString()}</small></td>
      <td>${escapeHtml(l.email||'')}</td>
      <td><small>${escapeHtml(l.message||'‚Äî')}</small></td>
    </tr>`).join('');
}

function escapeHtml(s=''){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));}

async function deleteItem(id){if(!confirm('Delete this GPT?'))return;await api(`/api/gpts/delete/${id}`,'DELETE');await loadAdminData();}
async function toggleFeature(id){const it=allItemsCache.find(i=>i.id===id);if(!it)return;await api(`/api/gpts/update/${id}`,'PUT',{...it,featured:!it.featured});await loadAdminData();}
async function toggleStatus(id){const it=allItemsCache.find(i=>i.id===id);if(!it)return;const ns=it.status==='live'?'hidden':'live';await api(`/api/gpts/update/${id}`,'PUT',{...it,status:ns});await loadAdminData();}
async function approve(id){const it=allItemsCache.find(i=>i.id===id);if(!it)return;await api(`/api/gpts/update/${id}`,'PUT',{...it,status:'live'});await loadAdminData();}
checkAuthAndLoad();
</script>
</body>
</html>
