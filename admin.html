<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — GPTMart</title>
  <meta name="robots" content="noindex, nofollow">
  <meta name="theme-color" content="#0b0f19" />
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#050815; --bg-2:#080e1f; --bg-3:#0b142a;
      --card:#0c1327; --card-2:#0e162f; --panel:#0b1a36;
      --text:#e6ecff; --muted:#a9b4c7; --accent:#6ea8ff; --accent-2:#3b82f6;
      --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --stroke:#16213a; --glow:0 0 0 2px rgba(110,168,255,.15), 0 30px 120px -40px rgba(60,120,255,.35);
      --radius:14px; --radius-lg:18px; --shadow:0 10px 40px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0; overflow-x:hidden;}
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:radial-gradient(1200px 600px at 80% -10%,#12244c22 0,#0000 70%), linear-gradient(180deg,var(--bg),#091229 60%, #0a1333 100%); color:var(--text);}
    a{color:inherit}
    .container{width:94%;max-width:1200px;margin:0 auto}
    .visually-hidden{position:absolute!important;clip:rect(1px,1px,1px,1px);padding:0;border:0;height:1px;width:1px;overflow:hidden;}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:50;background:rgba(5,8,21,.65);backdrop-filter:blur(10px);border-bottom:1px solid var(--stroke)}
    .top-row{display:flex;align-items:center;gap:16px;justify-content:space-between;padding:12px 0; flex-wrap: wrap;}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
    .brand svg{filter:drop-shadow(0 4px 18px rgba(110,168,255,.45))}
    .nav{display:flex;gap:8px; flex-wrap: wrap; align-items: center;}
    .chip{border:1px solid var(--stroke);background:linear-gradient(180deg,#0b1327,#091226);padding:8px 12px;border-radius:999px;color:#cbd5e1;text-decoration:none}
    .chip.active{background:linear-gradient(180deg,#1b2a55,#13224b);border-color:#21408b;box-shadow:var(--glow)}
    .btn{background:linear-gradient(180deg,#1b2a55,#142447);border:1px solid #1a2b5a;padding:10px 14px;border-radius:12px;color:#e7efff;text-decoration:none;font-weight:700;display:inline-flex;align-items:center;gap:8px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .btn:hover{border-color:#264890}
    .btn.accent{background:linear-gradient(180deg,#2c57c7,#2549a8);border-color:#2e53b7;box-shadow:0 6px 28px rgba(59,130,246,.35)}
    .section{padding:30px 0}
    .input{border:1px solid var(--stroke);background:linear-gradient(180deg,#091327,#071022);border-radius:12px;padding:12px 14px;color:var(--text); width: 100%; min-width: 0;}
    .input::placeholder{color:#8aa0c2}
    .grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:16px;margin-top:16px}
    .panel{background:linear-gradient(180deg,#0e1733,#0b1228);border:1px solid var(--stroke);border-radius:14px;padding:16px}
    .row{display:flex;gap:10px;align-items:center; margin-bottom: 8px; flex-wrap:wrap;}
    .row > .input {width: auto; flex-grow: 1;}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;font-size:14px}
    tbody tr{background:#0b1426}
    tbody td{padding:10px;border-top:1px solid var(--stroke);border-bottom:1px solid var(--stroke)}
    tbody tr td:first-child{border-left:1px solid var(--stroke);border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{ border-right:1px solid var(--stroke); border-top-right-radius:10px; border-bottom-right-radius:10px; display: flex; flex-wrap: wrap; gap: 6px; }
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:11px;border:1px dashed #2c3850;padding:4px 8px;border-radius:999px;color:#c7d2fe; cursor: pointer; background: transparent;}
    .tag.active{background:#1b2a55; border-color:#21408b; border-style:solid; color:#e7efff;}
    .hide{display:none!important}
  </style>
</head>
<body>
  <header class="topbar" role="navigation" aria-label="Top">
    <div class="container top-row">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 2l2.39 7.36h7.73l-6.25 4.54 2.39 7.36L12 16.72 5.74 21.9l2.39-7.36L1.88 9.36h7.73L12 2z" fill="url(#g)"/><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop stop-color="#6ea8ff"/><stop offset="1" stop-color="#3b82f6"/></linearGradient></defs></svg>
        <span id="siteLogo">GPTMart Admin</span>
      </div>
      <nav class="nav" aria-label="Views">
        <a class="chip" href="/">Explore</a>
        <a class="chip active" href="/admin.html">Admin</a>
      </nav>
      <div class="nav">
        <button class="btn" id="logoutBtn">Logout</button>
      </div>
    </div>
  </header>

  <main class="container section">
    <div id="adminGate">
      <div class="panel" style="max-width: 400px; margin: 40px auto;">
        <h3 style="margin:0 0 8px">Owner sign‑in</h3>
        <div id="loginMessage" style="color:var(--danger); margin-bottom:8px; font-size: 14px;"></div>
        <div class="row">
          <input id="pin" type="password" placeholder="Enter owner PIN" class="input" />
          <button class="btn accent" id="pinGo">Enter</button>
        </div>
      </div>
    </div>

    <div id="adminDesk" class="hide">
      <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
        <div class="panel"><h4 style="margin:.2rem 0">Live</h4><div id="kLive" style="font-weight:800;font-size:22px">0</div></div>
        <div class="panel"><h4 style="margin:.2rem 0">Featured</h4><div id="kFeat" style="font-weight:800;font-size:22px">0</div></div>
        <div class="panel"><h4 style="margin:.2rem 0">Hidden</h4><div id="kHidden" style="font-weight:800;font-size:22px">0</div></div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 10px">All Items</h3>
        <div class="panel">
          <div class="row" style="margin-bottom:10px;">
            <input id="aQ" class="input" placeholder="Filter items…" />
            <select id="aStatus" class="input" style="max-width:200px"><option value="all">All</option><option value="live">Live</option><option value="hidden">Hidden</option></select>
            <button class="btn" id="aReset">Reset</button>
            <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="exportBtn">Export JSON</button>
              <label class="btn" title="Import JSON"><input id="importFile" type="file" accept="application/json" style="display:none">Import</label>
              <button class="btn accent" id="addManual">＋ New</button>
            </div>
          </div>
          <div style="overflow-x:auto">
            <table>
              <thead><tr><th>Title</th><th>Cat/Tags</th><th>Featured</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="tAll"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 10px">Settings</h3>
        <div class="panel">
          <div class="row"><input id="siteTitle" class="input" placeholder="Site Title (public)"/></div>
          <div class="row" style="justify-content:flex-end"><button class="btn accent" id="saveSettings">Save Settings</button></div>
        </div>
      </div>
    </div>
  </main>
  
  <dialog id="modal" style="background: transparent; border: 0; max-width: 600px; width: 100%;">
    <form>
      <div class="panel" style="margin:0">
        <h3 id="mTitle">Add / Edit GPT</h3>
        <div class="row"><input id="mTitleIn" class="input" placeholder="Title" required></div>
        <div class="row"><input id="mUrlIn" class="input" placeholder="ChatGPT link (https://chatgpt.com/g/...)" required></div>
        <div class="row">
          <input id="mIconIn" class="input" placeholder="Paste Icon URL" style="flex-grow:1;">
        </div>
        <div class="row"><input id="mCatsIn" class="input" placeholder="Select one or more categories below"></div>
        <div id="mCatsSuggestions" class="tags" style="margin-bottom: 8px;"></div>
        <div class="row"><input id="mTagsIn" class="input" placeholder="Tags (e.g., api, web, data analysis)"></div>
        <div class="row"><input id="mDescIn" class="input" placeholder="Short description"></div>
        <div class="row">
          <label style="display:flex;gap:8px;align-items:center"><input id="mFeatIn" type="checkbox">Featured</label>
          <select id="mStatusIn" class="input" style="max-width:200px"><option value="live">Live</option><option value="hidden">Hidden</option></select>
        </div>
        <div class="row" style="justify-content:flex-end;gap:8px; margin-top: 16px;">
          <button id="mCancel" class="btn" type="button">Cancel</button>
          <button class="btn accent" id="mSave" type="submit">Save</button>
        </div>
      </div>
    </form>
  </dialog>
  
  <script>
    /*************** STATE & UTILS ***************/
    let ALL_ITEMS = [];
    const SESSION_TOKEN = 'gptmart.admin.token';
    const $  = (s,el=document)=> el.querySelector(s);
    const $$ = (s,el=document)=> Array.from(el.querySelectorAll(s));
    const uniq = arr => Array.from(new Set(arr));
    const toCSV = a => (a||[]).join(', ');
    const fromCSV = s => (s||'').split(',').map(x=>x.trim()).filter(Boolean);
    const contains = (t,q)=> (t||'').toLowerCase().includes((q||'').toLowerCase());

    /*************** API HELPERS ***************/
    async function api(endpoint, method = 'GET', body = null) {
        const headers = { 'Content-Type': 'application/json' };
        const token = sessionStorage.getItem(SESSION_TOKEN);
        if (token) headers['Authorization'] = `Bearer ${token}`;

        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);

        const response = await fetch(`/api${endpoint}`, options);

        if (response.status === 401) { // Unauthorized
            logout();
            return;
        }
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'API request failed');
        }
        return response.json();
    }


    /*************** AUTHENTICATION ***************/
    const adminGate = $('#adminGate');
    const adminDesk = $('#adminDesk');
    
    function logout() {
        sessionStorage.removeItem(SESSION_TOKEN);
        adminGate.classList.remove('hide');
        adminDesk.classList.add('hide');
    }

    async function checkAuth() {
        if (sessionStorage.getItem(SESSION_TOKEN)) {
            try {
                // Verify token is still valid with the backend
                await api('/auth/verify');
                adminGate.classList.add('hide');
                adminDesk.classList.remove('hide');
                initializeApp();
            } catch (e) {
                logout();
            }
        } else {
            adminGate.classList.remove('hide');
            adminDesk.classList.add('hide');
        }
    }

    $('#pinGo').addEventListener('click', async () => {
        const pin = $('#pin').value.trim();
        const loginMessage = $('#loginMessage');
        loginMessage.textContent = '';
        try {
            const data = await api('/auth/login', 'POST', { pin });
            sessionStorage.setItem(SESSION_TOKEN, data.token);
            await checkAuth();
        } catch (error) {
            loginMessage.textContent = error.message;
        }
    });
    
    $('#logoutBtn').addEventListener('click', logout);


    /*************** ADMIN DESK ***************/
    let currentEditId = null;

    function renderAdmin() {
      if (!ALL_ITEMS) return;
      $('#kLive').textContent   = ALL_ITEMS.filter(x=>x.status==='live').length;
      $('#kHidden').textContent = ALL_ITEMS.filter(x=>x.status==='hidden').length;
      $('#kFeat').textContent   = ALL_ITEMS.filter(x=>x.featured && x.status==='live').length;

      const q = ($('#aQ').value||'').trim();
      const st = $('#aStatus').value||'all';
      const filtered = ALL_ITEMS.filter(x=>{ 
          const inQ = !q || [x.title,x.desc,toCSV(x.tags),toCSV(x.categories)].some(v=>contains(v,q)); 
          const inS = st==='all' || x.status===st; 
          return inQ && inS; 
      });
      
      $('#tAll').innerHTML = filtered.map((x) => `
        <tr>
          <td>${x.title}</td>
          <td><small>${toCSV(x.categories)}</small><br><small style="color:#93c5fd">${toCSV(x.tags)}</small></td>
          <td>${x.featured ? '⭐️' : '—'}</td>
          <td>${x.status}</td>
          <td>
            <button class="btn" data-edit="${x.id}">Edit</button>
            <button class="btn" data-togglef="${x.id}">${x.featured?'Unfeature':'Feature'}</button>
            <button class="btn" data-toggleh="${x.id}">${x.status==='hidden'?'Unhide':'Hide'}</button>
            <a class="btn accent" href="${x.url}" target="_blank">Open</a>
            <button class="btn" data-del="${x.id}" style="border-color:#b91c1c; color:#fca5a5">Delete</button>
          </td>
        </tr>`).join('');

      $$('#tAll [data-edit]').forEach(b=> b.addEventListener('click', ()=> openModal(b.dataset.edit)));
      $$('#tAll [data-togglef]').forEach(b => b.addEventListener('click', () => toggleProperty(b.dataset.togglef, 'featured')));
      $$('#tAll [data-toggleh]').forEach(b => b.addEventListener('click', () => toggleProperty(b.dataset.toggleh, 'status')));
      $$('#tAll [data-del]').forEach(b=> b.addEventListener('click', ()=> deleteItem(b.dataset.del)));
    }

    async function toggleProperty(id, property) {
        const item = ALL_ITEMS.find(x => x.id === id);
        if (!item) return;

        let newValue;
        if (property === 'featured') {
            newValue = !item.featured;
        } else if (property === 'status') {
            newValue = item.status === 'hidden' ? 'live' : 'hidden';
        }
        
        try {
            await api(`/gpts/${id}`, 'PUT', { [property]: newValue });
            await fetchAllItems();
        } catch(e) {
            alert(`Error updating: ${e.message}`);
        }
    }

    async function deleteItem(id) {
        if(confirm('Are you sure you want to delete this item?')) {
            try {
                await api(`/gpts/${id}`, 'DELETE');
                await fetchAllItems();
            } catch(e) {
                alert(`Error deleting: ${e.message}`);
            }
        }
    }
    
    $('#aQ').addEventListener('input', renderAdmin);
    $('#aStatus').addEventListener('change', renderAdmin);
    $('#aReset').addEventListener('click', ()=>{ $('#aQ').value=''; $('#aStatus').value='all'; renderAdmin(); });

    $('#exportBtn').addEventListener('click', async () => {
        const data = { items: ALL_ITEMS, settings: { title: $('#siteTitle').value } };
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'gptmart-export.json'; a.click();
    });

    $('#importFile').addEventListener('change', async (e) => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader(); 
        reader.onload = async () => {
          try {
            const data = JSON.parse(reader.result);
            if (Array.isArray(data.items)) {
                if(confirm(`This will overwrite all existing data. Are you sure? (${data.items.length} items)`)) {
                    await api('/import', 'POST', data);
                    await fetchAllItems();
                    alert('Imported successfully!');
                }
            } else {
                alert('Invalid file format.');
            }
          } catch(err) { alert('Error reading file.'); }
        };
        reader.readAsText(file);
    });

    $('#saveSettings').addEventListener('click', async () => {
        try {
            await api('/settings', 'POST', { title: $('#siteTitle').value.trim() });
            alert('Settings saved');
        } catch(e) {
            alert(`Error saving settings: ${e.message}`);
        }
    });

    /*************** MODAL ***************/
    const modal = $('#modal');
    $('#addManual').addEventListener('click', ()=> openModal());
    
    function openModal(editId = null){
        currentEditId = editId;
        const editing = editId ? ALL_ITEMS.find(x => x.id === editId) : null;
        
        $('#mTitle').textContent = editing ? 'Edit GPT' : 'Add GPT';
        $('#mTitleIn').value = editing?.title || '';
        $('#mUrlIn').value = editing?.url || '';
        $('#mIconIn').value = editing?.icon || '';
        $('#mDescIn').value = editing?.desc || '';
        $('#mCatsIn').value = toCSV(editing?.categories);
        $('#mTagsIn').value = toCSV(editing?.tags);
        $('#mFeatIn').checked = !!editing?.featured;
        $('#mStatusIn').value = editing?.status || 'live';
        
        const suggestionsContainer = $('#mCatsSuggestions');
        const allCats = uniq(ALL_ITEMS.flatMap(x => x.categories || [])).sort();
        suggestionsContainer.innerHTML = allCats.map(cat => `<button type="button" class="tag" data-cat="${cat}">${cat}</button>`).join('');
        
        const syncCatButtons = () => {
          const selectedCats = fromCSV($('#mCatsIn').value);
          $$('#mCatsSuggestions .tag').forEach(btn => btn.classList.toggle('active', selectedCats.includes(btn.dataset.cat)));
        };

        $$('#mCatsSuggestions .tag').forEach(btn => {
          btn.onclick = () => {
            const catToAdd = btn.dataset.cat;
            const input = $('#mCatsIn');
            let currentCats = fromCSV(input.value);
            if (currentCats.includes(catToAdd)) {
              currentCats = currentCats.filter(c => c !== catToAdd);
            } else {
              currentCats.push(catToAdd);
            }
            input.value = toCSV(currentCats);
            syncCatButtons();
          };
        });
        
        $('#mCatsIn').addEventListener('input', syncCatButtons);
        syncCatButtons();
        modal.showModal();
    }
    
    modal.querySelector('form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const item = {
          title: $('#mTitleIn').value.trim(), url: $('#mUrlIn').value.trim(), icon: $('#mIconIn').value.trim(), desc: $('#mDescIn').value.trim(),
          categories: fromCSV($('#mCatsIn').value), tags: fromCSV($('#mTagsIn').value), featured: $('#mFeatIn').checked, status: $('#mStatusIn').value,
        };
        
        try {
            if (currentEditId) {
                await api(`/gpts/${currentEditId}`, 'PUT', item);
            } else {
                await api('/gpts', 'POST', item);
            }
            await fetchAllItems();
            modal.close();
        } catch(err) {
            alert(`Error saving: ${err.message}`);
        }
    });

    $('#mCancel').addEventListener('click', () => modal.close());

    /*************** INITIALIZATION ***************/
    async function fetchAllItems() {
        try {
            ALL_ITEMS = await api('/gpts/all');
            renderAdmin();
        } catch(e) {
            console.error("Failed to fetch admin data", e);
        }
    }

    async function initializeApp() {
        try {
            const settings = await api('/settings');
            $('#siteTitle').value = settings.title || '';
        } catch(e) {
            console.error("Failed to fetch settings", e);
        }
        await fetchAllItems();
    }

    // Run on page load
    checkAuth();

  </script>
</body>
</html>
